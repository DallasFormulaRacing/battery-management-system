# Software architecture

## Subdirectories (L1)

`App` - contains application layer logic, like algorithms and other user-defined modules. Write additional firmware here.

`Core` - main function and architecture-specific sources. Edit as least often as possible. Entry point of the program. This is not the same core as `App/core`, although they provide similar abstraction, their purposes are different. This `Core/` generated by CubeMX.

`Drivers` - vendor drivers and HAL. Also contains CMSIS library. Do not touch.

## Subdirectories (L2 in `App/`)

Within the `App` subdirectory is the full "flesh" of the BMS project's firmware.

![img](software/assets/app_layers.png)

```
.
├── api
│   ├── ...
├── core
│   ├── ...
├── lib
│   ├── ...
├── math
│   ├── ...
└── program

```

---

### `core`

is the lowest level and simplest of the 5. It wraps the HAL layer into simple wrapper functions and hides handler information. It pertains to all internal peripherals.

```
core
├── adc
├── can
├── fdcan
├── i2c
├── spi
└── tim
```

---

### `lib`

is the next highest and contains all external hardware. Any method of communicating with and handling TX/RX packets to and from these sensors are contained here, which makes use of the `core` layer above. Logic is sparse here -- that is to not say this code is dumb, but rather it is more imperative. In a sense, methods contained here can be thought of as stateless workers (policy vs mechanism, this is mechanism).

```
lib
├── adbms
├── amc
├── cab
├── elcon
├── gui
└── nvm
```

---

### `math`

is a helper library containing pure functions. it transforms the data into something meaningful, so that policy enforcers in upper-levels can parse it. it is a part of lib, but is intentionally left as platform independent; it is the only purely platform independent subdirectory in the project.

```
math
├── cb
├── pec
├── soc
└── thermal
```

---

### `api`

is the first layer where policy starts to be defined. it pulls data from `lib` and transforms it using `math` to populate high-level datasturctures.

it has a naming similarity (in terms of hardware/sensors) with `lib` and I want to note that it's intentional. while `lib` has part numbers and names, `api` has purpose. this is to capture the distinction between mechanism and policy (here it's policy)

```
api
├── charger
├── current
├── eeprom
├── interface
├── packvolt
└── segment
```

---

### `program`

is the orchestrator. it makes decisions based on high-level data provided by the `api` under it. it houses the state machine definition, the startup logic and the superloop (which executes the state machine).

---

## Full Tree

```bash
.
├── App
│   ├── api
│   │   ├── charger
│   │   ├── current
│   │   ├── eeprom
│   │   ├── interface
│   │   ├── packvolt
│   │   └── segment
│   ├── core
│   │   ├── adc
│   │   ├── can
│   │   ├── fdcan
│   │   ├── i2c
│   │   ├── spi
│   │   └── tim
│   ├── lib
│   │   ├── adbms
│   │   ├── amc
│   │   ├── cab
│   │   ├── elcon
│   │   ├── gui
│   │   └── nvm
│   ├── math
│   │   ├── cb
│   │   ├── pec
│   │   ├── soc
│   │   └── thermal
│   └── program
├── Core
│   ├── Inc
│   └── Src
├── Drivers
│   ├── CMSIS
│   │   ├── Device
│   │   └── Include
│   └── STM32G4xx_HAL_Driver
│       ├── Inc
│       └── Src
├── Tests
│   ├── CellBalancing
│   ├── FFF
│   └── Thermistor
├── build
│   ├── App
│   │   ├── CMakeFiles
│   │   ├── algorithms
│   │   ├── api
│   │   ├── core
│   │   ├── lib
│   │   ├── math
│   │   └── program
│   └── CMakeFiles
│       ├── 4.1.0
│       ├── bms.dir
│       └── pkgRedirects
├── cmake
│   └── stm32cubemx
└── submodules
    └── external
        └── unity_cmake

61 directories



```
